{"ast":null,"code":"// src/api/device.js\nimport axios from \"axios\";\nimport { safeGet, normalizeList } from \"./httpFactory\";\n\n// Device CRUD API runs on port 8000 (device.py)\nconst DEVICE_BASE_URL = process.env.REACT_APP_DEVICE_API_URL || `${window.location.protocol}//${window.location.hostname}:8000`;\nconst deviceApi = axios.create({\n  baseURL: DEVICE_BASE_URL,\n  timeout: 30000,\n  headers: {\n    \"Content-Type\": \"application/json\"\n  }\n});\nfunction pickMessage(v) {\n  if (!v) return null;\n  if (typeof v === \"string\") return v;\n  if (typeof v === \"object\") return v.message || v.detail || JSON.stringify(v);\n  return String(v);\n}\nfunction errMsg(err) {\n  var _err$response;\n  const data = err === null || err === void 0 ? void 0 : (_err$response = err.response) === null || _err$response === void 0 ? void 0 : _err$response.data;\n  return pickMessage(data === null || data === void 0 ? void 0 : data.detail) || pickMessage(data === null || data === void 0 ? void 0 : data.message) || pickMessage(data) || (err === null || err === void 0 ? void 0 : err.message) || \"Request failed\";\n}\nconst enc = v => encodeURIComponent(String(v !== null && v !== void 0 ? v : \"\"));\n\n/**\n * LIST devices\n * GET /devices?limit&offset&q\n */\nexport async function listDevices(limit = 100, offset = 0, q = \"\") {\n  try {\n    const params = {\n      limit,\n      offset\n    };\n    if (q) params.q = q;\n    const res = await deviceApi.get(\"/devices\", {\n      params\n    });\n    const {\n      items,\n      total\n    } = normalizeList(res.data);\n    return {\n      ok: true,\n      items,\n      total,\n      data: res.data\n    };\n  } catch (err) {\n    var _err$response2, _err$response3;\n    console.error(\"listDevices error:\", err);\n    return {\n      ok: false,\n      items: [],\n      total: 0,\n      status: err === null || err === void 0 ? void 0 : (_err$response2 = err.response) === null || _err$response2 === void 0 ? void 0 : _err$response2.status,\n      error: errMsg(err),\n      raw: err === null || err === void 0 ? void 0 : (_err$response3 = err.response) === null || _err$response3 === void 0 ? void 0 : _err$response3.data\n    };\n  }\n}\n\n/**\n * CREATE device\n * device.py expects POST /insert_device\n */\nexport async function insertDevice(payload) {\n  try {\n    var _payload$mobile_id;\n    const body = {\n      mobile_id: ((_payload$mobile_id = payload === null || payload === void 0 ? void 0 : payload.mobile_id) !== null && _payload$mobile_id !== void 0 ? _payload$mobile_id : \"\").trim(),\n      download_status: !!(payload !== null && payload !== void 0 && payload.download_status)\n    };\n    if (!body.mobile_id) return {\n      ok: false,\n      error: \"mobile_id is required\"\n    };\n    const res = await deviceApi.post(\"/insert_device\", body);\n    return {\n      ok: true,\n      data: res.data\n    };\n  } catch (err) {\n    var _err$response4, _err$response5;\n    console.error(\"insertDevice error:\", err);\n    return {\n      ok: false,\n      status: err === null || err === void 0 ? void 0 : (_err$response4 = err.response) === null || _err$response4 === void 0 ? void 0 : _err$response4.status,\n      error: errMsg(err),\n      raw: err === null || err === void 0 ? void 0 : (_err$response5 = err.response) === null || _err$response5 === void 0 ? void 0 : _err$response5.data\n    };\n  }\n}\n\n/**\n * DELETE device\n * device.py has DELETE /device/{mobile_id}\n * If FK linked, backend returns 409 with detail object containing recent_links\n */\nexport async function deleteDevice(mobileId) {\n  try {\n    const id = (mobileId !== null && mobileId !== void 0 ? mobileId : \"\").toString().trim();\n    if (!id) return {\n      ok: false,\n      error: \"mobile_id is required\"\n    };\n    const res = await deviceApi.delete(`/device/${enc(id)}`);\n    return {\n      ok: true,\n      data: res.data\n    };\n  } catch (err) {\n    var _err$response6, _err$response7;\n    const data = err === null || err === void 0 ? void 0 : (_err$response6 = err.response) === null || _err$response6 === void 0 ? void 0 : _err$response6.data;\n    const detailObj = data !== null && data !== void 0 && data.detail && typeof data.detail === \"object\" ? data.detail : null;\n    console.error(\"deleteDevice error:\", err);\n    return {\n      ok: false,\n      status: err === null || err === void 0 ? void 0 : (_err$response7 = err.response) === null || _err$response7 === void 0 ? void 0 : _err$response7.status,\n      error: errMsg(err),\n      // always string\n      detailObj,\n      // object with recent_links (if 409)\n      raw: data\n    };\n  }\n}\n\n/**\n * ONLINE status lives on DVSG service (port 8005)\n */\nexport async function getDeviceOnlineStatus(mobileId) {\n  var _r$data, _r$data2;\n  if (!mobileId) return {\n    ok: true,\n    online: false\n  };\n  const r = await safeGet(`/device/${encodeURIComponent(mobileId)}/online`);\n  if (!r.ok) return {\n    ok: false,\n    online: false,\n    error: r\n  };\n  return {\n    ok: true,\n    online: !!((_r$data = r.data) !== null && _r$data !== void 0 && _r$data.online) || r.data === true || !!((_r$data2 = r.data) !== null && _r$data2 !== void 0 && _r$data2.is_online)\n  };\n}","map":{"version":3,"names":["axios","safeGet","normalizeList","DEVICE_BASE_URL","process","env","REACT_APP_DEVICE_API_URL","window","location","protocol","hostname","deviceApi","create","baseURL","timeout","headers","pickMessage","v","message","detail","JSON","stringify","String","errMsg","err","_err$response","data","response","enc","encodeURIComponent","listDevices","limit","offset","q","params","res","get","items","total","ok","_err$response2","_err$response3","console","error","status","raw","insertDevice","payload","_payload$mobile_id","body","mobile_id","trim","download_status","post","_err$response4","_err$response5","deleteDevice","mobileId","id","toString","delete","_err$response6","_err$response7","detailObj","getDeviceOnlineStatus","_r$data","_r$data2","online","r","is_online"],"sources":["/home/ubuntu/loadboard/react-video/src/api/device.js"],"sourcesContent":["// src/api/device.js\nimport axios from \"axios\";\nimport { safeGet, normalizeList } from \"./httpFactory\";\n\n// Device CRUD API runs on port 8000 (device.py)\nconst DEVICE_BASE_URL =\n  process.env.REACT_APP_DEVICE_API_URL ||\n  `${window.location.protocol}//${window.location.hostname}:8000`;\n\nconst deviceApi = axios.create({\n  baseURL: DEVICE_BASE_URL,\n  timeout: 30000,\n  headers: { \"Content-Type\": \"application/json\" },\n});\n\nfunction pickMessage(v) {\n  if (!v) return null;\n  if (typeof v === \"string\") return v;\n  if (typeof v === \"object\") return v.message || v.detail || JSON.stringify(v);\n  return String(v);\n}\n\nfunction errMsg(err) {\n  const data = err?.response?.data;\n  return (\n    pickMessage(data?.detail) ||\n    pickMessage(data?.message) ||\n    pickMessage(data) ||\n    err?.message ||\n    \"Request failed\"\n  );\n}\n\nconst enc = (v) => encodeURIComponent(String(v ?? \"\"));\n\n/**\n * LIST devices\n * GET /devices?limit&offset&q\n */\nexport async function listDevices(limit = 100, offset = 0, q = \"\") {\n  try {\n    const params = { limit, offset };\n    if (q) params.q = q;\n\n    const res = await deviceApi.get(\"/devices\", { params });\n    const { items, total } = normalizeList(res.data);\n    return { ok: true, items, total, data: res.data };\n  } catch (err) {\n    console.error(\"listDevices error:\", err);\n    return {\n      ok: false,\n      items: [],\n      total: 0,\n      status: err?.response?.status,\n      error: errMsg(err),\n      raw: err?.response?.data,\n    };\n  }\n}\n\n/**\n * CREATE device\n * device.py expects POST /insert_device\n */\nexport async function insertDevice(payload) {\n  try {\n    const body = {\n      mobile_id: (payload?.mobile_id ?? \"\").trim(),\n      download_status: !!payload?.download_status,\n    };\n\n    if (!body.mobile_id) return { ok: false, error: \"mobile_id is required\" };\n\n    const res = await deviceApi.post(\"/insert_device\", body);\n    return { ok: true, data: res.data };\n  } catch (err) {\n    console.error(\"insertDevice error:\", err);\n    return {\n      ok: false,\n      status: err?.response?.status,\n      error: errMsg(err),\n      raw: err?.response?.data,\n    };\n  }\n}\n\n/**\n * DELETE device\n * device.py has DELETE /device/{mobile_id}\n * If FK linked, backend returns 409 with detail object containing recent_links\n */\nexport async function deleteDevice(mobileId) {\n  try {\n    const id = (mobileId ?? \"\").toString().trim();\n    if (!id) return { ok: false, error: \"mobile_id is required\" };\n\n    const res = await deviceApi.delete(`/device/${enc(id)}`);\n    return { ok: true, data: res.data };\n  } catch (err) {\n    const data = err?.response?.data;\n    const detailObj = data?.detail && typeof data.detail === \"object\" ? data.detail : null;\n\n    console.error(\"deleteDevice error:\", err);\n    return {\n      ok: false,\n      status: err?.response?.status,\n      error: errMsg(err),        // always string\n      detailObj,                 // object with recent_links (if 409)\n      raw: data,\n    };\n  }\n}\n\n/**\n * ONLINE status lives on DVSG service (port 8005)\n */\nexport async function getDeviceOnlineStatus(mobileId) {\n  if (!mobileId) return { ok: true, online: false };\n  const r = await safeGet(`/device/${encodeURIComponent(mobileId)}/online`);\n  if (!r.ok) return { ok: false, online: false, error: r };\n  return { ok: true, online: !!r.data?.online || r.data === true || !!r.data?.is_online };\n}\n\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}